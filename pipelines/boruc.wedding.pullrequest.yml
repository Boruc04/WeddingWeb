name: Boruc.WeddingWeb.PullRequest-$(FullSemVer)

trigger: none
pr:
  autoCancel: true
  branches:
    include:
      - master
  paths:
    include:
      - src/*
      - infrastructure/*
  drafts: false

variables:
  - name: terraformVersion
    value: '0.14.7'
  - name: tfvarsFileName
    value: 'test.tfvars' 

stages:
- stage: Prepare
  displayName: Wedding.Web.Prepare
  pool:
      vmImage: 'ubuntu-latest'
  jobs:
  - job: Build
    displayName: Build & Test App
    dependsOn: []
    variables:
      - name: projectPath
        value: 'src/**/WeddingWeb.csproj'
      - name: buildConfiguration
        value: 'Release'
      - name: testProjectPath
        value: 'test/**/*Tests.csproj'
    steps:
    - checkout: self
    - task: UseDotNet@2
      inputs:
        version: '5.x'
      displayName: Use Dot Net.
    - task: gitversion/setup@0
      inputs:
        versionSpec: '5.x'
    - task: gitversion/execute@0
      inputs:
        useConfigFile: true
        configFilePath: './pipelines/GitVersion/GitVersion.yml'
        additionalArguments: '/updateprojectfiles'
    - task: DotNetCoreCLI@2
      inputs:
        command: 'restore'
        projects: |
          $(projectPath)
          $(testProjectPath)
        feedsToUse: 'select'
      displayName: restore projects
    - task: DotNetCoreCLI@2
      inputs:
        command: 'build'
        projects: |
          $(projectPath)
          $(testProjectPath)
        configuration: $(buildConfiguration)
        arguments: '--no-restore'
      displayName: build projects
    - task: DotNetCoreCLI@2
      inputs:
        command: 'test'
        projects: '$(testProjectPath)'
        arguments: '--no-build'
        testRunTitle: 'Wedding Web Tests'
      displayName: run tests
    - task: DotNetCoreCLI@2
      inputs:
        command: publish
        publishWebProjects: True
        arguments: '--no-build --output $(Build.ArtifactStagingDirectory)'
        zipAfterPublish: True
      displayName: Create build artifact
    - task: PublishBuildArtifacts@1
      inputs:
        pathtoPublish: '$(Build.ArtifactStagingDirectory)' 
        artifactName: 'WeddingWeb'
      displayName: Publish build artifact.

  - job: CreateTestEnvironment
    displayName: Create Env - Apply Terraform
    dependsOn: []  
    steps:
      - checkout: self
      - task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@0
        inputs:
          terraformVersion: 'latest'
      - task: TerraformCLI@0
        inputs:
          command: 'init'
          workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/terraform'
          backendType: 'azurerm'
          backendServiceArm: 'Subskrypcja programu Visual Studio Professional(a8f64608-16de-41a8-880a-c0b812cebad3)'
          backendAzureRmResourceGroupName: 'boruc-common-eu-rg'
          backendAzureRmStorageAccountName: 'weddingwebterraform'
          backendAzureRmContainerName: 'terraform'
          backendAzureRmKey: 'terraform.tfstate'
          allowTelemetryCollection: true
        displayName: terraform init
      # - task: TerraformTaskV2@2
      #   inputs:
      #     provider: 'azurerm'
      #     command: 'init'
      #     workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/terraform'
      #     backendServiceArm: 'Subskrypcja programu Visual Studio Professional(a8f64608-16de-41a8-880a-c0b812cebad3)'
      #     backendAzureRmResourceGroupName: 'boruc-common-eu-rg'
      #     backendAzureRmStorageAccountName: 'weddingwebterraform'
      #     backendAzureRmContainerName: 'terraform'
      #     backendAzureRmKey: 'terraform.tfstate'
      #   displayName: terraform init
      - task: TerraformCLI@0
        inputs:
          command: 'apply'
          workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/terraform'
          environmentServiceName: 'Subskrypcja programu Visual Studio Professional(a8f64608-16de-41a8-880a-c0b812cebad3)'
          commandOptions: '-auto-approve -var-file="$(tfvarsFileName)"'
          allowTelemetryCollection: true
        displayName: terraform apply

      # - task: TerraformTaskV2@2
      #   inputs:
      #     provider: 'azurerm'
      #     command: 'apply'
      #     workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/terraform'
      #     commandOptions: '-auto-approve -var-file="$(tfvarsFileName)"'
      #     environmentServiceNameAzureRM: 'Subskrypcja programu Visual Studio Professional(a8f64608-16de-41a8-880a-c0b812cebad3)'
      #   displayName: terraform apply
      - task: TerraformCLI@0
        inputs:
          command: 'output'
          workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/terraform'
          allowTelemetryCollection: true
        name: TerraformOutput
        displayName: TerraformOutput

      - bash: |
          echo WebAppName valu: $(WebAppName).
          echo TF OUT WEBSITE NAME value: $(TF_OUT_WEBSITE_NAME).
        displayName: Check values before
      - bash: echo '##vso[task.setvariable variable=WebAppName;isOutput=true]$(TF_OUT_WEBSITE_NAME)'
        displayName: Set WebAppName variable value
      - bash: echo '##vso[task.setvariable variable=WebAppName2;isOutput=true]testValue'
        name: setvalue
        displayName: setvalue
      - bash: |
          echo WebAppName valu: $(WebAppName).
          echo TF OUT WEBSITE NAME value: $(TF_OUT_WEBSITE_NAME).
        displayName: Check values after

  - job: Deploy
    displayName: Deploy an application
    dependsOn: [Build, CreateTestEnvironment]
    variables:
      WebAppName2: $[ dependencies.CreateTestEnvironment.outputs['TerraformOutput.TF_OUT_WEBSITE_NAME'] ]
      WebAppName3: $[ dependencies.CreateTestEnvironment.outputs['setvalue.WebAppName2'] ]
    condition: succeeded()
    steps:
      - download: current
        artifact: WeddingWeb
      - bash: |
          echo WebAppName valu: $(WebAppName).
          echo WebAppName valu: $(WebAppName2).
          echo WebAppName valu: $(WebAppName3).
          echo TF OUT WEBSITE NAME value: $(TF_OUT_WEBSITE_NAME).
      - task: AzureRmWebAppDeployment@4
        inputs:
          ConnectionType: 'AzureRM'
          azureSubscription: 'Subskrypcja programu Visual Studio Professional(a8f64608-16de-41a8-880a-c0b812cebad3)'
          appType: 'webApp'
          WebAppName: $(WebAppName)
          packageForLinux: '$(Pipeline.Workspace)/**/WeddingWeb.zip'
        displayName: deploy application


- stage: DestroyTestEnvironment
  dependsOn: [Prepare]
  condition: always()
  displayName: Wedding.Web.TerraformDestroy
  jobs:
  - job: Delay
    pool: Server
    steps:
    - task: ManualValidation@0
      timeoutInMinutes: 1
      inputs:
        notifyUsers: 'm.borucinski@outlook.com'
        onTimeout: 'resume'
      displayName: Test and Approve

  - job: DestroyTest
    dependsOn: [Delay]
    condition: succeeded()
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - checkout: self
      - task: charleszipp.azure-pipelines-tasks-terraform.azure-pipelines-tasks-terraform-installer.TerraformInstaller@0
        inputs:
          terraformVersion: 'latest'
      - task: TerraformTaskV2@2
        inputs:
          provider: 'azurerm'
          command: 'init'
          workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/terraform'
          backendServiceArm: 'Subskrypcja programu Visual Studio Professional(a8f64608-16de-41a8-880a-c0b812cebad3)'
          backendAzureRmResourceGroupName: 'boruc-common-eu-rg'
          backendAzureRmStorageAccountName: 'weddingwebterraform'
          backendAzureRmContainerName: 'terraform'
          backendAzureRmKey: 'terraform.tfstate'
        displayName: terraform init
      - task: TerraformTaskV2@2
        inputs:
          provider: 'azurerm'
          command: 'destroy'
          workingDirectory: '$(System.DefaultWorkingDirectory)/infrastructure/terraform'
          commandOptions: '-auto-approve -var-file="$(tfvarsFileName)"'
          environmentServiceNameAzureRM: 'Subskrypcja programu Visual Studio Professional(a8f64608-16de-41a8-880a-c0b812cebad3)'
        displayName: terraform destory